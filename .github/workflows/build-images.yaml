name: Build and Push Config + Assertoor Image to Antithesis Registry

on:
  push:
    branches:
      - main  # Trigger this action on push to the main branch
  workflow_dispatch:  # Allows manual trigger

env:
  REGISTRY_URL: ${{ secrets.DOCKER_REGISTRY_URL }}
  REGISTRY_REPOSITORY: ${{ secrets.REPOSITORY }}
  
jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the code
    - name: Checkout the code
      uses: actions/checkout@v3

    - name: Login to Antithesis Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.DOCKER_REGISTRY_URL }}
        username: _json_key
        password: ${{ secrets.JSON_LOGIN_KEY }}

    - name: Build and push config image
      uses: docker/build-push-action@v5
      with:
        context: ./
        file: ./Dockerfile.config
        push: true
        tags: |
          ${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.REPOSITORY }}/config:antithesis-latest,
          ${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.REPOSITORY }}/config:${{ github.sha }}

    - name: Build and push assertoor image
      uses: docker/build-push-action@v5
      with:
        context: ./
        file: ./Dockerfile.assertoor
        push: true
        tags: |
          ${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.REPOSITORY }}/assertoor:antithesis-latest,
          ${{ secrets.DOCKER_REGISTRY_URL }}/${{ secrets.REPOSITORY }}/assertoor:${{ github.sha }}